<!DOCTYPE html>
<html>
<head>
    <title>NHM Collection preview</title>
    <meta charset="utf-8" />
    <script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="leaflet.js"></script>
    <script src="leaflet.utfgrid.js"></script>

    <script>
        $(document).ready(function(){
            var map = new L.Map('map');
            map.setView(new L.LatLng(51.505, -0.09), 4, true);
            L.tileLayer('http://otile1.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg', { opacity: 0.8 }).addTo(map);
            var baseURL = "http://localhost:4000/database/<%= dbname %>/table/<%= table %>/{z}/{x}/{y}";

            var layers = [];
            var controls = [];
            var tilejson = {
                tilejson: '1.0.0',
                scheme: 'xyz',
                tiles: [],
                grids: [],
                formatter: function(options, data) { return data._id + "/" + data.species + "/" + data.scientific_name }
            };

            var info = L.control();
            info.options.position = 'bottomright';
            info.onAdd = function (map) {
              this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
              this.update();
              return this._div;
            };

            info.update = function (props) {
              this._div.innerHTML = "<h4>Botany Records</h4>" + (props ?
              "<b>" + props.data.species + "</b><br />" + props.data._id+"<br />"+ props.data.scientific_name
              : 'Hover over a marker');
            };

            $('#update_map').click(function(ev){
                ev.preventDefault();

                var dbname = $('#dbname').val();
                var table = $('#table').val();
                var sub_collection = $('#sub_collection').val();
                var style = $('#style_toggle').is(':checked');

                var url = _.template(baseURL, {dbname: dbname, table: table});

                var sql = "";
                if (sub_collection) {
                  sql = "select * from botany_all where collection_sub_department = '"+sub_collection+"'";
                  tilejson.tiles = [url + '.png?sql=' + sql];
                  tilejson.grids = [url + '.grid.json?callback={cb}&sql=' + sql];
                } else {
                  tilejson.tiles = [url + '.png'];
                  tilejson.grids = [url + '.grid.json?callback={cb}'];
                }

                if (style) {
                  tilejson.tiles[0] = tilejson.tiles[0] + "&style=%40colora%3A+%23ffffb2%3B+%40colorb%3A+%23fecc5c%3B+%40colorc%3A+%23fd8d3c%3B+%40colord%3A+%23f03b20%3B+%40colore%3A+%23bd0026%3B++%23botany_all+%7B+++marker-width%3A+10%3B+++marker-line-width%3A+0.8%3B+++marker-line-color%3A+white%3B+++marker-fill%3A+%23bbb%3B+++marker-allow-overlap%3A+true%3B+++%5Bscientific_name_author_year+%3D~+'17.*'%5D%3A%3Aoverlay+%7B+++++marker-fill%3A+%40colorb%3B+++++marker-width%3A+12%3B+++++marker-allow-overlap%3A+true%3B+++++marker-line-width%3A+0.8%3B+++++marker-line-color%3A+white%3B+++%7D+++%5Bscientific_name_author_year+%3D~+'18.*'%5D%3A%3Aoverlay+%7B+++++marker-fill%3A+%40colorc%3B+++++marker-width%3A+12%3B+++++marker-allow-overlap%3A+true%3B+++++marker-line-width%3A+0.8%3B+++++marker-line-color%3A+white%3B+++%7D+++%5Bscientific_name_author_year+%3D~+'19.*'%5D%3A%3Aoverlay+%7B+++++marker-fill%3A+%40colord%3B+++++marker-width%3A+12%3B+++++marker-allow-overlap%3A+true%3B+++++marker-line-width%3A+0.8%3B+++++marker-line-color%3A+white%3B+++%7D+++%5Bscientific_name_author_year+%3D~+'20.*'%5D%3A%3Aoverlay+%7B+++++marker-fill%3A+%40colore%3B+++++marker-width%3A+12%3B+++++marker-allow-overlap%3A+true%3B+++++marker-line-width%3A+0.8%3B+++++marker-line-color%3A+white%3B+++%7D+%7D";
                }

                _.each(layers, function(layer){
                    map.removeLayer(layer)
                });

                _.each(controls, function(control) {
                  map.removeControl(control)
                });

                layers = [];
                controls = [];

                var testMap = L.tileLayer(tilejson.tiles[0]).addTo(map);
                var utfGrid = new L.UtfGrid(tilejson.grids[0], {
                  resolution: 4
                });
                utfGrid.on('mouseover', function(e){ info.update(e);}).on('mouseout', function(e){ info.update();})
                map.addLayer(utfGrid);
                map.addControl(info);

                controls.push(info);
                layers.push(utfGrid);
                layers.push(testMap);
            });
        });
    </script>

    <link rel="stylesheet" href="leaflet.css" />
    <link rel="stylesheet" href="maps.css" />
</head>
<body>
<input type="text" value="nhm_botany" id="dbname">
<input type="text" value="botany_all" id="table">
<select id="sub_collection">
  <option />
  <option value="Bryophytes">Bryophytes</option>
  <option value="Algae">Algae</option>
  <option value="Ferns">Ferns</option>
</select>
<input type="checkbox" id="style_toggle">
<input type="button" id="update_map" value="Go">
<div id="map" style="width: 1500px; height: 900px"></div>
</body>
</html>
